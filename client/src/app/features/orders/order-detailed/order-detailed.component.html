@if (order) {
    <mat-card class="bg-white py-8 shadow-md max-w-screen-lg mx-auto">
        <div class="px-4 w-full">
            <div class="flex justify-between items-center align-middle">
                <h2 class="text-2xl text-center font-semibold">Order summary for order #{{order.id}}</h2>
                <button (click)="onReturnClick()" mat-stroked-button>{{buttonText}}</button>
            </div>
            <div class="mt-8 py-3 border-t border-gray-200 flex gap-16">
                <div class="space-y-2">
                    <h4 class="text-lg font-semibold">Billing and delivery information</h4>
                    <dl>
                        <dt class="font-medium">Shipping address</dt>
                        <dd class="mt-1 font-light">{{order.shippingAddress | address}}</dd>
                    </dl>
                    <dl>
                        <dt class="font-medium">Payment info</dt>
                        <dd class="mt-1 font-light">{{order.paymentSummary | paymentCard}}</dd>
                    </dl>
                </div>
                <div class="space-y-2">
                    <h4 class="text-lg font-semibold">Order details</h4>
                    <dl>
                        <dt class="font-medium">Email address</dt>
                        <dd class="mt-1 font-light">{{order.buyerEmail}}</dd>
                    </dl>
                    <dl>
                        <dt class="font-medium">Order status</dt>
                        <dd class="mt-1 font-light">{{order.status}}</dd>
                    </dl>
                    @if (order.cancelledReason) {
                        <dl>
                            <dt class="font-medium">Cancellation reason</dt>
                            <dd class="mt-1 font-light">{{order.cancelledReason}}</dd>
                        </dl>
                    }
                    @if (order.trackingNumber) {
                        <dl>
                            <dt class="font-medium">Tracking</dt>
                            <dd class="mt-1 font-light">
                                <span>{{order.trackingNumber}}</span>
                                @if (order.trackingUrl) {
                                    <a class="ml-2 text-primary hover:underline" [href]="order.trackingUrl" target="_blank" rel="noopener">Track</a>
                                }
                            </dd>
                        </dl>
                    }
                    @if (order.deliveryUpdateDetails) {
                        <dl>
                            <dt class="font-medium">Delivery update</dt>
                            <dd class="mt-1 font-light">{{order.deliveryUpdateDetails}}</dd>
                        </dl>
                    }
                    <dl>
                        <dt class="font-medium">Order date</dt>
                        <dd class="mt-1 font-light">{{order.orderDate | date: 'medium'}}</dd>
                    </dl>
                </div>
            </div>

            @if (isAdmin) {
                <div class="mt-6 border-t border-gray-200 pt-6">
                    <h4 class="text-lg font-semibold mb-4">Order management</h4>
                    <form [formGroup]="statusForm" class="grid grid-cols-1 md:grid-cols-2 gap-4" (ngSubmit)="updateStatus()">
                        <mat-form-field appearance="outline" class="w-full">
                            <mat-label>Status</mat-label>
                            <mat-select formControlName="status">
                                @for (status of adminStatusOptions; track status) {
                                    <mat-option [value]="status">{{status}}</mat-option>
                                }
                            </mat-select>
                        </mat-form-field>
                        @if (statusForm.get('status')?.value === 'Shipped') {
                            <mat-form-field appearance="outline" class="w-full">
                                <mat-label>Tracking number</mat-label>
                                <input matInput formControlName="trackingNumber">
                            </mat-form-field>
                            <mat-form-field appearance="outline" class="w-full">
                                <mat-label>Tracking URL</mat-label>
                                <input matInput formControlName="trackingUrl">
                            </mat-form-field>
                        }
                        @if (statusForm.get('status')?.value === 'Cancelled') {
                            <mat-form-field appearance="outline" class="w-full md:col-span-2">
                                <mat-label>Cancel reason</mat-label>
                                <textarea matInput formControlName="cancelReason" rows="2"></textarea>
                            </mat-form-field>
                        }
                        <mat-form-field appearance="outline" class="w-full md:col-span-2">
                            <mat-label>Delivery update details</mat-label>
                            <textarea matInput formControlName="deliveryDetails" rows="2"></textarea>
                        </mat-form-field>
                        <div class="md:col-span-2 flex justify-end">
                            <button mat-flat-button color="primary" type="submit">Update status</button>
                        </div>
                    </form>
                </div>
            } @else if (canCancelOrder) {
                <div class="mt-6 border-t border-gray-200 pt-6">
                    <h4 class="text-lg font-semibold mb-4">Cancel order</h4>
                    <form [formGroup]="cancelForm" class="grid grid-cols-1 md:grid-cols-2 gap-4" (ngSubmit)="cancelOrder()">
                        <mat-form-field appearance="outline" class="w-full md:col-span-2">
                            <mat-label>Reason (optional)</mat-label>
                            <textarea matInput formControlName="reason" rows="2"></textarea>
                        </mat-form-field>
                        <div class="md:col-span-2 flex justify-end">
                            <button mat-stroked-button color="warn" type="submit">Cancel order</button>
                        </div>
                    </form>
                </div>
            }

            <div class="mt-4">
                <div class="border-y border-gray-200">
                    <table class="w-full text-center">
                        <tbody class="divide-y divide-gray-200">
                            @for (item of order.orderItems; track item.productId + '-' + item.size) {
                                <tr>
                        <td class="py-4">
                            <div class="flex items-center gap-4">
                                <img src="{{item.pictureUrl}}" alt="product image" 
                                    class="w-10 h-10">
                                <span>{{item.productName}}</span>
                            </div>
                            <div class="mt-2 flex items-center gap-3 text-xs text-gray-700">
                                @if (item.reviewRating) {
                                    <app-star-rating [value]="item.reviewRating" size="sm"></app-star-rating>
                                    <span class="text-gray-500">{{item.reviewDate | date: 'mediumDate'}}</span>
                                    <button mat-button color="primary" class="px-2" (click)="openReviewDialog(item)">Edit review</button>
                                } @else if (item.canReview) {
                                    <button mat-stroked-button color="primary" class="px-2" (click)="openReviewDialog(item)">Write a review</button>
                                } @else if (item.reviewId) {
                                    <button mat-stroked-button color="primary" class="px-2" (click)="openReviewDialog(item)">Edit review</button>
                                }
                            </div>
                        </td>
                        <td class="p-4">{{item.size}}</td>
                        <td class="p-4">x{{item.quantity}}</td>
                        <td class="p-4 text-right">{{item.price | currency}}</td>
                    </tr>
                }
            </tbody>
        </table>
                </div>
            </div>

            <div class="space-y-4 rounded-lg border-y border-gray-200 p-4 bg-white">
                <p class="text-xl font-semibold">Order summary</p>
                <div class="space-y-4">
                    <div class="space-y-2">
                        <dl class="flex items-center justify-between gap-4">
                            <dt class="font-medium text-gray-500">Subtotal</dt>
                            <dd class="font-medium text-gray-900">
                                {{order.subtotal | currency}}
                            </dd>
                        </dl>
                        <dl class="flex items-center justify-between gap-4">
                            <dt class="font-medium text-gray-500">Discount</dt>
                            <dd class="font-medium text-green-500">
                                -{{order.discount | currency}}
                            </dd>
                        </dl>
                        <dl class="flex items-center justify-between gap-4">
                            <dt class="font-medium text-gray-500">Delivery fee</dt>
                            <dd class="font-medium text-gray-900">
                                {{order.shippingPrice| currency}}
                            </dd>
                        </dl>
                    </div>
        
                    <dl class="flex items-center justify-between gap-4 border-t border-gray-200 pt-2">
                        <dt class="font-medium text-gray-500">Total</dt>
                        <dd class="font-medium text-gray-900">
                            {{order.total | currency}}
                        </dd>
                    </dl>
                </div>
                 
            </div>

        </div>
    </mat-card>
}
