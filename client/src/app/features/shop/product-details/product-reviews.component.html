<section id="reviews-section" class="mt-10 space-y-4">
  <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-3">
    <div class="flex items-center gap-3">
      <app-star-rating
        [value]="ratingAverage || 0"
        [showValue]="true"
        size="md">
      </app-star-rating>
      <span class="text-sm text-gray-600">({{ totalReviews }} reviews)</span>
    </div>
    <div class="flex gap-2">
      @if (canAddReview) {
        <button mat-flat-button color="primary" (click)="openReviewDialog()">Write a review</button>
      } @else if (hasUserReview) {
        <button mat-stroked-button color="primary" (click)="openReviewDialog(userReview)">Edit my review</button>
      }
    </div>
  </div>

  @if (!isLoggedIn) {
    <div class="text-sm text-gray-600">Sign in to share your experience with this product.</div>
  }

  <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-3">
    <mat-form-field appearance="outline" class="w-full md:w-64">
      <mat-label>Sort reviews</mat-label>
      <mat-select [value]="reviewParams.sort" (valueChange)="onSortChange($event)">
        @for (option of sortOptions; track option.value) {
          <mat-option [value]="option.value">{{ option.label }}</mat-option>
        }
      </mat-select>
    </mat-form-field>

    <mat-paginator
      class="bg-white rounded border"
      [length]="reviews?.count || 0"
      [pageSize]="reviewParams.pageSize"
      [pageIndex]="reviewParams.pageNumber - 1"
      [pageSizeOptions]="[3,5,10]"
      (page)="onPageChange($event)">
    </mat-paginator>
  </div>

  <mat-divider></mat-divider>

  @if (loading) {
    <div class="text-sm text-gray-600">Loading reviews...</div>
  } @else if (reviews?.data?.length) {
    <div class="space-y-4">
      @for (review of (reviews?.data ?? []); track review.id) {
        <article class="border border-gray-200 rounded-lg p-4 bg-white">
          <div class="flex items-start justify-between gap-3">
            <div class="space-y-1">
              <app-star-rating [value]="review.rating" size="sm"></app-star-rating>
              <div class="text-xs text-gray-500">
                {{review.author}} &bull; {{review.createdAt | date: 'mediumDate'}}
              </div>
            </div>
            @if (review.isOwner) {
              <div class="flex gap-2">
                <button mat-button color="primary" (click)="openReviewDialog(review)">Edit</button>
                <button mat-button color="warn" (click)="deleteReview(review)">Delete</button>
              </div>
            }
          </div>

          @if (review.title) {
            <h4 class="mt-2 text-sm font-semibold text-gray-900">{{review.title}}</h4>
          }
          @if (review.content) {
            <p class="mt-1 text-sm text-gray-700 whitespace-pre-line">{{review.content}}</p>
          }

          @if (review.adminResponse) {
            <div class="mt-3 p-3 border border-amber-100 bg-amber-50 rounded-md">
              <div class="text-xs font-semibold text-amber-800">Store reply</div>
              <div class="text-sm text-gray-800">{{review.adminResponse}}</div>
              @if (review.adminRespondedAt) {
                <div class="text-xs text-gray-500 mt-1">
                  {{review.adminRespondedAt | date: 'mediumDate'}}
                </div>
              }
            </div>
          }
        </article>
      }
    </div>
  } @else {
    <app-empty-state 
      message="No reviews yet"
      icon="rate_review"
      [actionText]="canAddReview ? 'Be the first to review' : ''"
      (action)="canAddReview && openReviewDialog()"
    />
  }
</section>
