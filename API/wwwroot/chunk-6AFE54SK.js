import{b as pe}from"./chunk-EEDA453I.js";import{a as te}from"./chunk-YTDSK5ZT.js";import{Ha as re,Ma as ne,Pa as ie,Ta as oe,Ua as ae,Va as se,Wa as le,Xa as ce,b as V,da as ee,fb as de,ga as E,hb as ue,l as $}from"./chunk-3VDJTOIS.js";import{Db as W,Ec as D,Ib as c,Jb as d,Nc as J,Ob as A,Qc as Y,Rb as N,Tb as z,Uc as Z,_ as Q,ba as R,bc as u,cb as y,dc as S,e as m,ea as P,fc as G,gc as H,hc as X,jc as K,ka as h,nc as g,oa as B,oc as b,qb as T,w as f,wb as F,x as _,xa as U,ya as j,yb as k}from"./chunk-XXTPASVJ.js";var me="useandom-26T198340PX75pxJACKVERYMINDBUSHWOLF_GQZbfghjklqvwyzrict";var fe=(o=21)=>{let r="",l=crypto.getRandomValues(new Uint8Array(o));for(;o--;)r+=me[l[o]&63];return r};var L=class{constructor(){this.id=fe(),this.items=[]}};var M=(()=>{let r=class r{constructor(){this.baseUrl=E.apiUrl,this.http=h(V),this.cart=T(null),this.itemCount=D(()=>this.cart()?.items.reduce((e,t)=>e+t.quantity,0)),this.selectedDelivery=T(null),this.totals=D(()=>{let e=this.cart(),t=this.selectedDelivery();if(!e)return null;let i=e.items.reduce((s,p)=>s+p.price*p.quantity,0),n=0;e.coupon&&(e.coupon.amountOff?n=e.coupon.amountOff:e.coupon.percentOff&&(n=i*(e.coupon.percentOff/100)));let a=t?t.price:0;return{subtotal:i,shipping:a,discount:n,total:i+a-n}})}getCart(e){return this.http.get(this.baseUrl+"cart?id="+e).pipe(_(t=>(this.cart.set(t),t)))}setCart(e){return this.http.post(this.baseUrl+"cart",e).pipe(R(t=>{this.cart.set(t)}))}applyDiscount(e){return this.http.get(this.baseUrl+"coupons/"+e)}addItemToCart(e,t=1,i){return m(this,null,function*(){let n=this.cart()??this.createCart();if(this.isProduct(e)){if(!i)throw new Error("Size is required");let a=e,s=a.variants?.find(v=>v.size===i);if(!s||s.quantityInStock<=0)throw new Error(`Size ${i} is out of stock`);let p=n.items.filter(v=>v.productId===a.id&&v.size===i).reduce((v,I)=>v+I.quantity,0);if(p+t>s.quantityInStock)throw new Error(`Only ${s.quantityInStock-p} left in stock for size ${i}`);e=this.mapProductToCartItem(a,i,s.quantityInStock)}n.items=this.addOrUpdateItem(n.items,e,t),yield f(this.setCart(n))})}removeItemFromCart(e,t=1,i){return m(this,null,function*(){let n=this.cart();if(!n)return;let a=n.items.findIndex(s=>s.productId===e&&(i?s.size===i:!0));a!==-1&&(n.items[a].quantity>t?n.items[a].quantity-=t:n.items.splice(a,1),n.items.length===0?this.deleteCart():yield f(this.setCart(n)))})}deleteCart(){this.http.delete(this.baseUrl+"cart?id="+this.cart()?.id).subscribe({next:()=>{localStorage.removeItem("cart_id"),this.cart.set(null)}})}addOrUpdateItem(e,t,i){let n=e.findIndex(s=>s.productId===t.productId&&s.size===t.size),a=t.maxQuantity??(n!==-1?e[n].maxQuantity:null);if(n===-1){if(a&&i>a)return e;t.quantity=i,t.maxQuantity=a??t.maxQuantity??null,e.push(t)}else{let s=e[n].quantity+i,p=a??null;p&&s>p?e[n].quantity=p:e[n].quantity=s,e[n].maxQuantity=p??e[n].maxQuantity??null}return e}mapProductToCartItem(e,t,i){let n=e.salePrice??null,a=n!==null&&n>0&&n<e.price?n:e.price,s=a!==e.price;return{productId:e.id,productName:e.name,price:a,originalPrice:e.price,salePrice:s?e.salePrice:null,lowestPrice:e.lowestPrice??null,maxQuantity:i??null,quantity:0,pictureUrl:e.pictureUrl??"",brand:e.brand,type:e.type,size:t}}isProduct(e){return e.id!==void 0}createCart(){let e=new L;return localStorage.setItem("cart_id",e.id),e}};r.\u0275fac=function(t){return new(t||r)},r.\u0275prov=P({token:r,factory:r.\u0275fac,providedIn:"root"});let o=r;return o})();var Se="https://js.stripe.com/v3",xe=/^https:\/\/js\.stripe\.com\/v3\/?(\?.*)?$/,ye="loadStripe.setLoadParameters was called but an existing Stripe.js script already exists in the document; existing script parameters will be used",Ce=function(){for(var r=document.querySelectorAll('script[src^="'.concat(Se,'"]')),l=0;l<r.length;l++){var e=r[l];if(xe.test(e.src))return e}return null},ve=function(r){var l=r&&!r.advancedFraudSignals?"?advancedFraudSignals=false":"",e=document.createElement("script");e.src="".concat(Se).concat(l);var t=document.head||document.body;if(!t)throw new Error("Expected document.body not to be null. Stripe.js requires a <body> element.");return t.appendChild(e),e},Ie=function(r,l){!r||!r._registerWrapper||r._registerWrapper({name:"stripe-js",version:"4.0.0",startTime:l})},x=null,O=null,q=null,_e=function(r){return function(){r(new Error("Failed to load Stripe.js"))}},Pe=function(r,l){return function(){window.Stripe?r(window.Stripe):l(new Error("Stripe.js not available"))}},Ue=function(r){return x!==null?x:(x=new Promise(function(l,e){if(typeof window>"u"||typeof document>"u"){l(null);return}if(window.Stripe&&r&&console.warn(ye),window.Stripe){l(window.Stripe);return}try{var t=Ce();if(t&&r)console.warn(ye);else if(!t)t=ve(r);else if(t&&q!==null&&O!==null){var i;t.removeEventListener("load",q),t.removeEventListener("error",O),(i=t.parentNode)===null||i===void 0||i.removeChild(t),t=ve(r)}q=Pe(l,e),O=_e(e),t.addEventListener("load",q),t.addEventListener("error",O)}catch(n){e(n);return}}),x.catch(function(l){return x=null,Promise.reject(l)}))},je=function(r,l,e){if(r===null)return null;var t=r.apply(void 0,l);return Ie(t,e),t},C,we=!1,ge=function(){return C||(C=Ue(null).catch(function(r){return C=null,Promise.reject(r)}),C)};Promise.resolve().then(function(){return ge()}).catch(function(o){we||console.warn(o)});var be=function(){for(var r=arguments.length,l=new Array(r),e=0;e<r;e++)l[e]=arguments[e];we=!0;var t=Date.now();return ge().then(function(i){return je(i,l,t)})};var Ee=(()=>{let r=class r{constructor(){this.baseUrl=E.apiUrl,this.cartService=h(M),this.accountService=h(pe),this.http=h(V),this.stripePromise=be(E.stripePublicKey)}getStripeInstance(){return this.stripePromise}initializeElements(){return m(this,null,function*(){if(!this.elements){let e=yield this.getStripeInstance();if(e){let t=yield f(this.createOrUpdatePaymentIntent());this.elements=e.elements({clientSecret:t.clientSecret,appearance:{labels:"floating"},locale:"en"})}else throw new Error("Stripe has not been loaded")}return this.elements})}createPaymentElement(){return m(this,null,function*(){if(!this.paymentElement){let e=yield this.initializeElements();if(e){let t={paymentMethodOrder:["card"],wallets:{applePay:"never",googlePay:"never"},fields:{billingDetails:{name:"never",email:"never",phone:"never",address:"never"}}};this.paymentElement=e.create("payment",t)}else throw new Error("Elements instance has not been initialized")}return this.paymentElement})}createAddressElement(){return m(this,null,function*(){if(!this.addressElement){let e=yield this.initializeElements();if(e){let t=this.accountService.currentUser(),i={};t&&(i.name=t.firstName+" "+t.lastName),t?.address&&(i.address={line1:t.address.line1,line2:t.address.line2,city:t.address.city,state:t.address.state,country:t.address.country,postal_code:t.address.postalCode});let n={mode:"shipping",defaultValues:i};this.addressElement=e.create("address",n)}else throw new Error("Elements instance has not been loaded")}return this.addressElement})}createConfirmationToken(e){return m(this,null,function*(){let t=yield this.getStripeInstance(),i=yield this.initializeElements(),n=yield i.submit();if(n.error)throw new Error(n.error.message);if(t){let a=e?.name?.trim()??null,s=e?.email?.trim()??null,p=e?.phone?.trim()??null,w={payment_method_data:{billing_details:{name:a,email:s,phone:p,address:e?.address}}};return yield t.createConfirmationToken({elements:i,params:w})}else throw new Error("Stripe not available")})}confirmPayment(e){return m(this,null,function*(){let t=yield this.getStripeInstance(),n=yield(yield this.initializeElements()).submit();if(n.error)throw new Error(n.error.message);let a=this.cartService.cart()?.clientSecret;if(t&&a)return yield t.confirmPayment({clientSecret:a,confirmParams:{confirmation_token:e.id},redirect:"if_required"});throw new Error("Unable to load stripe")})}createOrUpdatePaymentIntent(){let e=this.cartService.cart();if(!e)throw new Error("Problem with cart");return this.http.post(this.baseUrl+"payments/"+e.id,{}).pipe(Q(t=>this.cartService.setCart(t).pipe(_(()=>t))))}disposeElements(){this.elements=void 0,this.addressElement=void 0,this.paymentElement=void 0}};r.\u0275fac=function(t){return new(t||r)},r.\u0275prov=P({token:r,factory:r.\u0275fac,providedIn:"root"});let o=r;return o})();function ke(o,r){o&1&&(c(0,"div",11)(1,"button",19),u(2,"Checkout"),d(),c(3,"button",20),u(4,"Continue Shopping"),d()())}function Ve(o,r){if(o&1){let l=A();c(0,"div",21)(1,"span",22),u(2),d(),c(3,"button",23),N("click",function(){U(l);let t=z();return j(t.removeCouponCode())}),c(4,"mat-icon",24),u(5,"delete"),d()()()}if(o&2){let l=r.ngIf;y(2),S("",l.name," applied")}}var vt=(()=>{let r=class r{constructor(){this.cartService=h(M),this.stripeService=h(Ee),this.location=h(J)}applyCouponCode(){this.code&&this.cartService.applyDiscount(this.code).subscribe({next:e=>m(this,null,function*(){let t=this.cartService.cart();t&&(t.coupon=e,yield f(this.cartService.setCart(t)),this.code=void 0,this.location.path()==="/checkout"&&(yield f(this.stripeService.createOrUpdatePaymentIntent())))})})}removeCouponCode(){return m(this,null,function*(){let e=this.cartService.cart();e&&(e.coupon&&(e.coupon=void 0),yield f(this.cartService.setCart(e)),this.location.path()==="/checkout"&&(yield f(this.stripeService.createOrUpdatePaymentIntent())))})}};r.\u0275fac=function(t){return new(t||r)},r.\u0275cmp=B({type:r,selectors:[["app-order-summary"]],standalone:!0,features:[K],decls:43,vars:17,consts:[["form","ngForm"],[1,"mx-auto","max-w-4xl","flex-1","space-y-6","w-full"],[1,"space-y-4","rounded-lg","border","border-gray-200","p-4","bg-white","shadow-sm"],[1,"text-xl","font-semibold"],[1,"space-y-4"],[1,"space-y-2"],[1,"flex","items-center","justify-between","gap-4"],[1,"font-medium","text-gray-500"],[1,"font-medium","text-gray-900"],[1,"font-medium","text-green-500"],[1,"flex","items-center","justify-between","gap-4","border-t","border-gray-200","pt-2"],[1,"flex","flex-col","gap-2"],[1,"space-y-4","rounded-lg","border","border-gray-200","bg-white","shadow-sm"],[1,"space-y-2","flex","flex-col","p-2",3,"ngSubmit"],[1,"mb-2","block","text-sm","font-mediem"],["class","flex justify-between items-center",4,"ngIf"],["appearance","outline"],["name","code","type","text","matInput","",3,"ngModelChange","disabled","ngModel"],["type","submit","mat-flat-button","",3,"disabled"],["routerLink","/checkout","mat-flat-button",""],["routerLink","/shop","mat-button",""],[1,"flex","justify-between","items-center"],[1,"text-sm","font-semibold"],["mat-icon-button","",3,"click"],["color","warn"]],template:function(t,i){if(t&1){let n=A();c(0,"div",1)(1,"div",2)(2,"p",3),u(3,"Order summary"),d(),c(4,"div",4)(5,"div",5)(6,"dl",6)(7,"dt",7),u(8,"Subtotal"),d(),c(9,"dd",8),u(10),g(11,"currency"),d()(),c(12,"dl",6)(13,"dt",7),u(14,"Discount"),d(),c(15,"dd",9),u(16),g(17,"currency"),d()(),c(18,"dl",6)(19,"dt",7),u(20,"Delivery fee"),d(),c(21,"dd",8),u(22),g(23,"currency"),d()()(),c(24,"dl",10)(25,"dt",7),u(26,"Total"),d(),c(27,"dd",8),u(28),g(29,"currency"),d()()(),F(30,ke,5,0,"div",11),d(),c(31,"div",12)(32,"form",13,0),N("ngSubmit",function(){return U(n),j(i.applyCouponCode())}),c(34,"label",14),u(35," Do you have a voucher code? "),d(),F(36,Ve,6,1,"div",15),c(37,"mat-form-field",16)(38,"mat-label"),u(39,"Voucher code"),d(),c(40,"input",17),X("ngModelChange",function(s){return U(n),H(i.code,s)||(i.code=s),j(s)}),d()(),c(41,"button",18),u(42,"Apply code"),d()()()()}if(t&2){let n,a,s,p,w,v,I;y(10),S(" ",b(11,9,(n=i.cartService.totals())==null?null:n.subtotal)," "),y(6),S(" -",b(17,11,(a=i.cartService.totals())==null?null:a.discount)," "),y(6),S(" ",b(23,13,(s=i.cartService.totals())==null?null:s.shipping)," "),y(6),S(" ",b(29,15,(p=i.cartService.totals())==null?null:p.total)," "),y(2),W(i.location.path()!=="/checkout"?30:-1),y(6),k("ngIf",(w=i.cartService.cart())==null?null:w.coupon),y(4),k("disabled",!!((v=i.cartService.cart())!=null&&v.coupon)),G("ngModel",i.code),y(),k("disabled",!!((I=i.cartService.cart())!=null&&I.coupon))}},dependencies:[ee,$,ne,re,ue,Z,de,ce,ie,oe,ae,le,se,Y,te]});let o=r;return o})();export{M as a,Ee as b,vt as c};
