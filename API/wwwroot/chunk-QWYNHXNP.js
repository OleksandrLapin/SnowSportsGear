import{b as ue}from"./chunk-F2CL3FRF.js";import{a as ee}from"./chunk-WWPLOOYK.js";import{A as te,E as re,H as ie,L as ne,M as oe,N as ae,O as se,P as le,X as ce,Z as de}from"./chunk-SFWUMCY3.js";import{b as V,ja as $,k as Z,ma as b}from"./chunk-65R2IPWI.js";import{Cb as W,Dc as D,Hb as l,Ib as c,Mc as Q,Nb as q,Pc as J,Qb as A,Sb as z,Sc as Y,ac as d,ba as R,cb as h,cc as S,e as m,ea as _,ec as G,fc as H,gc as X,ic as K,ka as f,mc as w,nc as g,oa as B,qb as F,vb as T,w as p,x as I,xa as P,xb as j,ya as U}from"./chunk-B2RMFUCK.js";var me="useandom-26T198340PX75pxJACKVERYMINDBUSHWOLF_GQZbfghjklqvwyzrict";var pe=(o=21)=>{let r="",a=crypto.getRandomValues(new Uint8Array(o));for(;o--;)r+=me[a[o]&63];return r};var L=class{constructor(){this.id=pe(),this.items=[]}};var k=(()=>{let r=class r{constructor(){this.baseUrl=b.apiUrl,this.http=f(V),this.cart=F(null),this.itemCount=D(()=>this.cart()?.items.reduce((e,t)=>e+t.quantity,0)),this.selectedDelivery=F(null),this.totals=D(()=>{let e=this.cart(),t=this.selectedDelivery();if(!e)return null;let i=e.items.reduce((u,v)=>u+v.price*v.quantity,0),n=0;e.coupon&&(e.coupon.amountOff?n=e.coupon.amountOff:e.coupon.percentOff&&(n=i*(e.coupon.percentOff/100)));let s=t?t.price:0;return{subtotal:i,shipping:s,discount:n,total:i+s-n}})}getCart(e){return this.http.get(this.baseUrl+"cart?id="+e).pipe(I(t=>(this.cart.set(t),t)))}setCart(e){return this.http.post(this.baseUrl+"cart",e).pipe(R(t=>{this.cart.set(t)}))}applyDiscount(e){return this.http.get(this.baseUrl+"coupons/"+e)}addItemToCart(e,t=1,i){return m(this,null,function*(){let n=this.cart()??this.createCart();if(this.isProduct(e)){if(!i)throw new Error("Size is required");let s=e,u=n.items.filter(y=>y.productId===s.id&&y.size===i).reduce((y,C)=>y+C.quantity,0);if(u+t>s.quantityInStock)throw new Error(`Only ${s.quantityInStock-u} left in stock`);e=this.mapProductToCartItem(s,i)}n.items=this.addOrUpdateItem(n.items,e,t),yield p(this.setCart(n))})}removeItemFromCart(e,t=1,i){return m(this,null,function*(){let n=this.cart();if(!n)return;let s=n.items.findIndex(u=>u.productId===e&&(i?u.size===i:!0));s!==-1&&(n.items[s].quantity>t?n.items[s].quantity-=t:n.items.splice(s,1),n.items.length===0?this.deleteCart():yield p(this.setCart(n)))})}deleteCart(){this.http.delete(this.baseUrl+"cart?id="+this.cart()?.id).subscribe({next:()=>{localStorage.removeItem("cart_id"),this.cart.set(null)}})}addOrUpdateItem(e,t,i){let n=e.findIndex(s=>s.productId===t.productId&&s.size===t.size);return n===-1?(t.quantity=i,e.push(t)):e[n].quantity+=i,e}mapProductToCartItem(e,t){return{productId:e.id,productName:e.name,price:e.price,quantity:0,pictureUrl:e.pictureUrl??"",brand:e.brand,type:e.type,size:t}}isProduct(e){return e.id!==void 0}createCart(){let e=new L;return localStorage.setItem("cart_id",e.id),e}};r.\u0275fac=function(t){return new(t||r)},r.\u0275prov=_({token:r,factory:r.\u0275fac,providedIn:"root"});let o=r;return o})();var ve="https://js.stripe.com/v3",Ee=/^https:\/\/js\.stripe\.com\/v3\/?(\?.*)?$/,he="loadStripe.setLoadParameters was called but an existing Stripe.js script already exists in the document; existing script parameters will be used",xe=function(){for(var r=document.querySelectorAll('script[src^="'.concat(ve,'"]')),a=0;a<r.length;a++){var e=r[a];if(Ee.test(e.src))return e}return null},ye=function(r){var a=r&&!r.advancedFraudSignals?"?advancedFraudSignals=false":"",e=document.createElement("script");e.src="".concat(ve).concat(a);var t=document.head||document.body;if(!t)throw new Error("Expected document.body not to be null. Stripe.js requires a <body> element.");return t.appendChild(e),e},Ce=function(r,a){!r||!r._registerWrapper||r._registerWrapper({name:"stripe-js",version:"4.0.0",startTime:a})},E=null,O=null,M=null,Ie=function(r){return function(){r(new Error("Failed to load Stripe.js"))}},_e=function(r,a){return function(){window.Stripe?r(window.Stripe):a(new Error("Stripe.js not available"))}},Pe=function(r){return E!==null?E:(E=new Promise(function(a,e){if(typeof window>"u"||typeof document>"u"){a(null);return}if(window.Stripe&&r&&console.warn(he),window.Stripe){a(window.Stripe);return}try{var t=xe();if(t&&r)console.warn(he);else if(!t)t=ye(r);else if(t&&M!==null&&O!==null){var i;t.removeEventListener("load",M),t.removeEventListener("error",O),(i=t.parentNode)===null||i===void 0||i.removeChild(t),t=ye(r)}M=_e(a,e),O=Ie(e),t.addEventListener("load",M),t.addEventListener("error",O)}catch(n){e(n);return}}),E.catch(function(a){return E=null,Promise.reject(a)}))},Ue=function(r,a,e){if(r===null)return null;var t=r.apply(void 0,a);return Ce(t,e),t},x,Se=!1,we=function(){return x||(x=Pe(null).catch(function(r){return x=null,Promise.reject(r)}),x)};Promise.resolve().then(function(){return we()}).catch(function(o){Se||console.warn(o)});var ge=function(){for(var r=arguments.length,a=new Array(r),e=0;e<r;e++)a[e]=arguments[e];Se=!0;var t=Date.now();return we().then(function(i){return Ue(i,a,t)})};var be=(()=>{let r=class r{constructor(){this.baseUrl=b.apiUrl,this.cartService=f(k),this.accountService=f(ue),this.http=f(V),this.stripePromise=ge(b.stripePublicKey)}getStripeInstance(){return this.stripePromise}initializeElements(){return m(this,null,function*(){if(!this.elements){let e=yield this.getStripeInstance();if(e){let t=yield p(this.createOrUpdatePaymentIntent());this.elements=e.elements({clientSecret:t.clientSecret,appearance:{labels:"floating"}})}else throw new Error("Stripe has not been loaded")}return this.elements})}createPaymentElement(){return m(this,null,function*(){if(!this.paymentElement){let e=yield this.initializeElements();if(e)this.paymentElement=e.create("payment");else throw new Error("Elements instance has not been initialized")}return this.paymentElement})}createAddressElement(){return m(this,null,function*(){if(!this.addressElement){let e=yield this.initializeElements();if(e){let t=this.accountService.currentUser(),i={};t&&(i.name=t.firstName+" "+t.lastName),t?.address&&(i.address={line1:t.address.line1,line2:t.address.line2,city:t.address.city,state:t.address.state,country:t.address.country,postal_code:t.address.postalCode});let n={mode:"shipping",defaultValues:i};this.addressElement=e.create("address",n)}else throw new Error("Elements instance has not been loaded")}return this.addressElement})}createConfirmationToken(){return m(this,null,function*(){let e=yield this.getStripeInstance(),t=yield this.initializeElements(),i=yield t.submit();if(i.error)throw new Error(i.error.message);if(e)return yield e.createConfirmationToken({elements:t});throw new Error("Stripe not available")})}confirmPayment(e){return m(this,null,function*(){let t=yield this.getStripeInstance(),n=yield(yield this.initializeElements()).submit();if(n.error)throw new Error(n.error.message);let s=this.cartService.cart()?.clientSecret;if(t&&s)return yield t.confirmPayment({clientSecret:s,confirmParams:{confirmation_token:e.id},redirect:"if_required"});throw new Error("Unable to load stripe")})}createOrUpdatePaymentIntent(){let e=this.cartService.cart(),t=!!e?.clientSecret;if(!e)throw new Error("Problem with cart");return this.http.post(this.baseUrl+"payments/"+e.id,{}).pipe(I(i=>m(this,null,function*(){return t||(yield p(this.cartService.setCart(i))),i})))}disposeElements(){this.elements=void 0,this.addressElement=void 0,this.paymentElement=void 0}};r.\u0275fac=function(t){return new(t||r)},r.\u0275prov=_({token:r,factory:r.\u0275fac,providedIn:"root"});let o=r;return o})();function je(o,r){o&1&&(l(0,"div",11)(1,"button",19),d(2,"Checkout"),c(),l(3,"button",20),d(4,"Continue Shopping"),c()())}function Ve(o,r){if(o&1){let a=q();l(0,"div",21)(1,"span",22),d(2),c(),l(3,"button",23),A("click",function(){P(a);let t=z();return U(t.removeCouponCode())}),l(4,"mat-icon",24),d(5,"delete"),c()()()}if(o&2){let a=r.ngIf;h(2),S("",a.name," applied")}}var yt=(()=>{let r=class r{constructor(){this.cartService=f(k),this.stripeService=f(be),this.location=f(Q)}applyCouponCode(){this.code&&this.cartService.applyDiscount(this.code).subscribe({next:e=>m(this,null,function*(){let t=this.cartService.cart();t&&(t.coupon=e,yield p(this.cartService.setCart(t)),this.code=void 0,this.location.path()==="/checkout"&&(yield p(this.stripeService.createOrUpdatePaymentIntent())))})})}removeCouponCode(){return m(this,null,function*(){let e=this.cartService.cart();e&&(e.coupon&&(e.coupon=void 0),yield p(this.cartService.setCart(e)),this.location.path()==="/checkout"&&(yield p(this.stripeService.createOrUpdatePaymentIntent())))})}};r.\u0275fac=function(t){return new(t||r)},r.\u0275cmp=B({type:r,selectors:[["app-order-summary"]],standalone:!0,features:[K],decls:43,vars:17,consts:[["form","ngForm"],[1,"mx-auto","max-w-4xl","flex-1","space-y-6","w-full"],[1,"space-y-4","rounded-lg","border","border-gray-200","p-4","bg-white","shadow-sm"],[1,"text-xl","font-semibold"],[1,"space-y-4"],[1,"space-y-2"],[1,"flex","items-center","justify-between","gap-4"],[1,"font-medium","text-gray-500"],[1,"font-medium","text-gray-900"],[1,"font-medium","text-green-500"],[1,"flex","items-center","justify-between","gap-4","border-t","border-gray-200","pt-2"],[1,"flex","flex-col","gap-2"],[1,"space-y-4","rounded-lg","border","border-gray-200","bg-white","shadow-sm"],[1,"space-y-2","flex","flex-col","p-2",3,"ngSubmit"],[1,"mb-2","block","text-sm","font-mediem"],["class","flex justify-between items-center",4,"ngIf"],["appearance","outline"],["name","code","type","text","matInput","",3,"ngModelChange","disabled","ngModel"],["type","submit","mat-flat-button","",3,"disabled"],["routerLink","/checkout","mat-flat-button",""],["routerLink","/shop","mat-button",""],[1,"flex","justify-between","items-center"],[1,"text-sm","font-semibold"],["mat-icon-button","",3,"click"],["color","warn"]],template:function(t,i){if(t&1){let n=q();l(0,"div",1)(1,"div",2)(2,"p",3),d(3,"Order summary"),c(),l(4,"div",4)(5,"div",5)(6,"dl",6)(7,"dt",7),d(8,"Subtotal"),c(),l(9,"dd",8),d(10),w(11,"currency"),c()(),l(12,"dl",6)(13,"dt",7),d(14,"Discount"),c(),l(15,"dd",9),d(16),w(17,"currency"),c()(),l(18,"dl",6)(19,"dt",7),d(20,"Delivery fee"),c(),l(21,"dd",8),d(22),w(23,"currency"),c()()(),l(24,"dl",10)(25,"dt",7),d(26,"Total"),c(),l(27,"dd",8),d(28),w(29,"currency"),c()()(),T(30,je,5,0,"div",11),c(),l(31,"div",12)(32,"form",13,0),A("ngSubmit",function(){return P(n),U(i.applyCouponCode())}),l(34,"label",14),d(35," Do you have a voucher code? "),c(),T(36,Ve,6,1,"div",15),l(37,"mat-form-field",16)(38,"mat-label"),d(39,"Voucher code"),c(),l(40,"input",17),X("ngModelChange",function(u){return P(n),H(i.code,u)||(i.code=u),U(u)}),c()(),l(41,"button",18),d(42,"Apply code"),c()()()()}if(t&2){let n,s,u,v,y,C,N;h(10),S(" ",g(11,9,(n=i.cartService.totals())==null?null:n.subtotal)," "),h(6),S(" -",g(17,11,(s=i.cartService.totals())==null?null:s.discount)," "),h(6),S(" ",g(23,13,(u=i.cartService.totals())==null?null:u.shipping)," "),h(6),S(" ",g(29,15,(v=i.cartService.totals())==null?null:v.total)," "),h(2),W(i.location.path()!=="/checkout"?30:-1),h(6),j("ngIf",(y=i.cartService.cart())==null?null:y.coupon),h(4),j("disabled",!!((C=i.cartService.cart())!=null&&C.coupon)),G("ngModel",i.code),h(),j("disabled",!!((N=i.cartService.cart())!=null&&N.coupon))}},dependencies:[$,Z,re,te,de,Y,ce,le,ie,ne,oe,se,ae,J,ee]});let o=r;return o})();export{k as a,be as b,yt as c};
